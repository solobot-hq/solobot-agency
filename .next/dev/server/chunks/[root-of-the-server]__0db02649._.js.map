{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bolad/Downloads/SoloBotAgency_SaaS_Starter/app/api/bots/ai-sales-agent/variations/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst client = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const { formData, count, type } = body;\r\n\r\n    const baseContext = `\r\n    Context:\r\n    Audience: ${formData.targetAudience}\r\n    Offer: ${formData.productDetails}\r\n    Pain Points: ${formData.painPoints}\r\n    Tone: ${formData.tone}\r\n    `;\r\n\r\n    let systemInstruction = \"You are a specialized sales copy engine. You output strict JSON only.\";\r\n    let userPrompt = \"\";\r\n\r\n    // 1. Subject Lines Logic\r\n    if (type === \"subjects\") {\r\n      systemInstruction = `\r\n      You are an expert at writing high-open-rate cold email subject lines.\r\n      \r\n      RULES:\r\n      1. Length: Under 6 words.\r\n      2. Style: Casual, lowercase, pattern-interrupt. NO \"Salesy\" caps.\r\n      3. Output: JSON Object with a key \"items\" containing an array of objects.\r\n      \r\n      Each object must have:\r\n      - \"subject\": The subject line text.\r\n      - \"openRateScore\": Number 0-100.\r\n      - \"spamRisk\": \"Low\", \"Medium\", or \"High\".\r\n      `;\r\n      \r\n      userPrompt = `${baseContext}\\nGenerate 5 distinct subject lines.`;\r\n    } \r\n    \r\n    // 2. A/B Test Logic\r\n    else if (type === \"ab-test\") {\r\n      systemInstruction = `\r\n      You are an A/B testing expert. Generate two distinct email versions.\r\n      \r\n      Output strictly this JSON structure:\r\n      {\r\n        \"A\": \"Full email text for Version A (Direct, concise, benefit-focused)...\",\r\n        \"B\": \"Full email text for Version B (Story-based, problem-agitation, emotional)...\"\r\n      }\r\n      \r\n      Do NOT wrap in an array. Do NOT use \"items\". Return exactly keys \"A\" and \"B\".\r\n      `;\r\n      \r\n      userPrompt = `${baseContext}\\nGenerate the A/B test variants now.`;\r\n    } \r\n    \r\n    // 3. Variations Logic (Default)\r\n    else {\r\n      const num = count || 3;\r\n      systemInstruction = `\r\n      You are a sales copywriter. Generate ${num} distinct variations of the cold email.\r\n      \r\n      Output: JSON Object with a key \"items\" containing an ARRAY of STRINGS.\r\n      Example: { \"items\": [\"Email 1 text...\", \"Email 2 text...\", \"Email 3 text...\"] }\r\n      \r\n      Do NOT return objects inside the array. Just strings.\r\n      `;\r\n      \r\n      userPrompt = `${baseContext}\\nGenerate ${num} variations.`;\r\n    }\r\n\r\n    const completion = await client.chat.completions.create({\r\n      model: \"gpt-4o-mini\",\r\n      messages: [\r\n        { role: \"system\", content: systemInstruction },\r\n        { role: \"user\", content: userPrompt },\r\n      ],\r\n      response_format: { type: \"json_object\" },\r\n      temperature: 0.8,\r\n    });\r\n\r\n    const content = completion.choices[0].message.content || \"{}\";\r\n    const parsed = JSON.parse(content);\r\n\r\n    // --- Corrected extraction logic (handles all GPT JSON shapes) ---\r\n    let items = parsed.items;\r\n\r\n    // Handle nested shapes (GPT sometimes returns { items: { list: [...] } })\r\n    if (items?.list && Array.isArray(items.list)) {\r\n      items = items.list;\r\n    }\r\n\r\n    // 1. Subject Lines -> Array of Objects\r\n    if (type === \"subjects\") {\r\n      return NextResponse.json({\r\n        result: Array.isArray(items) ? items : []\r\n      });\r\n    }\r\n\r\n    // 2. A/B Test -> Object { A: string, B: string }\r\n    if (type === \"ab-test\") {\r\n      return NextResponse.json({ result: parsed });\r\n    }\r\n\r\n    // 3. Variations -> Array of Strings\r\n    return NextResponse.json({\r\n      result: Array.isArray(items) ? items : []\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error(\"Variations API Error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Error generating variations\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;;;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,QAAQ,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG;QAElC,MAAM,cAAc,CAAC;;cAEX,EAAE,SAAS,cAAc,CAAC;WAC7B,EAAE,SAAS,cAAc,CAAC;iBACpB,EAAE,SAAS,UAAU,CAAC;UAC7B,EAAE,SAAS,IAAI,CAAC;IACtB,CAAC;QAED,IAAI,oBAAoB;QACxB,IAAI,aAAa;QAEjB,yBAAyB;QACzB,IAAI,SAAS,YAAY;YACvB,oBAAoB,CAAC;;;;;;;;;;;;MAYrB,CAAC;YAED,aAAa,GAAG,YAAY,oCAAoC,CAAC;QACnE,OAGK,IAAI,SAAS,WAAW;YAC3B,oBAAoB,CAAC;;;;;;;;;;MAUrB,CAAC;YAED,aAAa,GAAG,YAAY,qCAAqC,CAAC;QACpE,OAGK;YACH,MAAM,MAAM,SAAS;YACrB,oBAAoB,CAAC;2CACgB,EAAE,IAAI;;;;;;MAM3C,CAAC;YAED,aAAa,GAAG,YAAY,WAAW,EAAE,IAAI,YAAY,CAAC;QAC5D;QAEA,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO;YACP,UAAU;gBACR;oBAAE,MAAM;oBAAU,SAAS;gBAAkB;gBAC7C;oBAAE,MAAM;oBAAQ,SAAS;gBAAW;aACrC;YACD,iBAAiB;gBAAE,MAAM;YAAc;YACvC,aAAa;QACf;QAEA,MAAM,UAAU,WAAW,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI;QACzD,MAAM,SAAS,KAAK,KAAK,CAAC;QAE1B,mEAAmE;QACnE,IAAI,QAAQ,OAAO,KAAK;QAExB,0EAA0E;QAC1E,IAAI,OAAO,QAAQ,MAAM,OAAO,CAAC,MAAM,IAAI,GAAG;YAC5C,QAAQ,MAAM,IAAI;QACpB;QAEA,uCAAuC;QACvC,IAAI,SAAS,YAAY;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,QAAQ,MAAM,OAAO,CAAC,SAAS,QAAQ,EAAE;YAC3C;QACF;QAEA,iDAAiD;QACjD,IAAI,SAAS,WAAW;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;YAAO;QAC5C;QAEA,oCAAoC;QACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,QAAQ,MAAM,OAAO,CAAC,SAAS,QAAQ,EAAE;QAC3C;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA8B,GACvC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}