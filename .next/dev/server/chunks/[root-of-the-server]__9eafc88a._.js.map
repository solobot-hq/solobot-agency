{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bolad/Downloads/SoloBotAgency_SaaS_Starter/app/api/bots/email-assistant/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst client = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const { \r\n      recipient, \r\n      subject, \r\n      keyPoints, \r\n      rawEmail, \r\n      tone, \r\n      mode, \r\n      rewriteMode, \r\n      generateSubjectLines, \r\n      variationSeed \r\n    } = body;\r\n\r\n    // -------------------------------\r\n    // 1. Safety & Input Handling\r\n    // -------------------------------\r\n    // Check either keyPoints (Compose mode) or rawEmail (Fix mode)\r\n    if ((!keyPoints || keyPoints.trim().length === 0) && (!rawEmail || rawEmail.trim().length === 0)) {\r\n      return NextResponse.json(\r\n        { error: \"Content (Key Points or Raw Email) is required.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Prevent runaway inputs\r\n    const safeKeyPoints = keyPoints ? String(keyPoints).slice(0, 4000) : \"\";\r\n    const safeRawEmail = rawEmail ? String(rawEmail).slice(0, 4000) : \"\";\r\n    const safeRecipient = String(recipient || \"Valued Contact\").slice(0, 120);\r\n    const safeSubject = String(subject || \"\").slice(0, 240);\r\n    const safeTone = tone || \"Professional\";\r\n    \r\n    // Determine the primary operation type\r\n    const isFixMode = mode === \"fix\";\r\n    const isRewrite = mode === \"rewrite\";\r\n    const isCompose = !isFixMode && !isRewrite;\r\n\r\n    // -------------------------------\r\n    // 2. SYSTEM PROMPT (THE ENGINE BRAIN)\r\n    // -------------------------------\r\n    const systemPrompt = `\r\nYou are the Email Output Engine for SoloBotAgency. Your task is to produce \r\n**premium, subscription-worthy email outputs** that outperform all major competitors.\r\n\r\n===========================\r\nüî• CORE EMAIL RULES\r\n===========================\r\n1. Emails must be human, emotionally intelligent, persuasive, and high-impact.\r\n2. ANTI-PATTERNS (NEVER USE):\r\n   ‚ùå \"I hope this finds you well\"\r\n   ‚ùå \"I'm writing to...\"\r\n   ‚ùå \"Following up...\"\r\n   ‚ùå \"Delve\", \"Leverage\", \"Synergy\", \"Transformative\", \"Game-changer\"\r\n\r\n3. OPENING LINE must reference recipient‚Äôs world or insight to hook attention immediately.\r\n4. EXACTLY ONE persuasion framework must be selected and applied from this list:\r\n   [PAS, BAB, Challenger, SPICED, Story Selling, Executive Brevity, Emotional Resonance, ROI Power Pitch]\r\n\r\n5. Use human rhythm: micro-pauses (‚Äî ‚Ä¶), impact lines, varied sentence length.\r\n6. CTA must match context (soft | direct | conversational | time-bound).\r\n\r\n===========================\r\nüöÄ PREMIUM REWRITE MODES\r\n===========================\r\nIf a specific rewrite mode is requested, ADAPT AGGRESSIVELY:\r\n- **Executive Rewrite**: Ultra-concise, BLUF (Bottom Line Up Front), remove all fluff, focus on decision/ROI.\r\n- **Storytelling Version**: Use a narrative arc, open with a hook/anecdote, connect emotionally.\r\n- **Sales Conversion**: Focus on pain points, urgency, and a clear, low-friction CTA.\r\n- **Cold Outreach**: Pattern interrupt opener, immediate value prop, soft ask (credibility focused).\r\n- **Empathy Rewrite**: High emotional intelligence, validating language, supportive tone, relationship-first.\r\n\r\n===========================\r\nüõ†Ô∏è FIX MY EMAIL MODE\r\n===========================\r\nIf in \"Fix My Email\" mode:\r\n1. Identify the core intent of the raw input.\r\n2. STRIP all messiness, rambling, and bad grammar.\r\n3. RESTRUCTURE perfectly using a persuasion framework.\r\n4. ELEVATE the vocabulary and tone to World-Class standards.\r\n\r\n===========================\r\nüî• STRICT JSON OUTPUT\r\n===========================\r\nReturn ONLY valid JSON (no markdown blocks):\r\n\r\n{\r\n  \"email\": \"<final email body>\",\r\n  \"subjectLines\": [\"<Subject Option 1>\", \"<Subject Option 2>\", \"<Subject Option 3>\"],\r\n  \"frameworkUsed\": \"<name of framework used>\",\r\n  \"ctaType\": \"<soft | direct | conversational | time-bound>\",\r\n  \"toneApplied\": \"<explanation of tone>\",\r\n  \"whyThisWorks\": [\r\n    \"<Educational point 1: Why the structure works>\",\r\n    \"<Educational point 2: Psychology/Persuasion tactic used>\",\r\n    \"<Educational point 3: Why the CTA was chosen>\"\r\n  ]\r\n}\r\n`;\r\n\r\n    // --------------------------------\r\n    // 3. USER PROMPT CONSTRUCTION\r\n    // --------------------------------\r\n    let taskInstruction = \"\";\r\n    let inputContext = \"\";\r\n\r\n    if (isFixMode) {\r\n      taskInstruction = `TASK: FIX & UPGRADE this raw email. Make it perfect. Rewrite Mode: ${rewriteMode || \"General Improvement\"}.`;\r\n      inputContext = `RAW INPUT TO FIX:\\n\"${safeRawEmail}\"`;\r\n    } else if (isRewrite) {\r\n      taskInstruction = `TASK: REWRITE existing draft. Apply mode: ${rewriteMode}. Make it structurally different. Variation Seed: ${variationSeed}`;\r\n      inputContext = `ORIGINAL DRAFT:\\n\"${safeKeyPoints}\"`;\r\n    } else {\r\n      taskInstruction = `TASK: GENERATE from scratch. Variation Seed: ${variationSeed}`;\r\n      inputContext = `KEY POINTS / CONTEXT:\\n\"${safeKeyPoints}\"`;\r\n    }\r\n\r\n    const userPrompt = `\r\nINPUT DATA:\r\nRecipient: ${safeRecipient}\r\nSubject Context: ${safeSubject}\r\nTone: ${safeTone}\r\nGenerate Subject Lines: ${generateSubjectLines ? \"YES (Provide 3-5 variations)\" : \"NO (Provide 1 best option)\"}\r\n\r\n${taskInstruction}\r\n\r\n${inputContext}\r\n\r\nReturn ONLY strict JSON.\r\n`;\r\n\r\n    // --------------------------------\r\n    // 4. EXECUTION (GPT-4o-mini JSON MODE)\r\n    // --------------------------------\r\n    const completion = await client.chat.completions.create({\r\n      model: \"gpt-4o-mini\",\r\n      messages: [\r\n        { role: \"system\", content: systemPrompt },\r\n        { role: \"user\", content: userPrompt }\r\n      ],\r\n      response_format: { type: \"json_object\" },\r\n      temperature: 0.85, \r\n      presence_penalty: 0.5,\r\n      frequency_penalty: 0.3,\r\n    });\r\n\r\n    let content = completion.choices?.[0]?.message?.content || \"{}\";\r\n    content = content.replace(/^```json\\s*/, \"\").replace(/\\s*```$/, \"\");\r\n\r\n    let parsedResult;\r\n    try {\r\n      parsedResult = JSON.parse(content);\r\n    } catch {\r\n      parsedResult = { \r\n        email: content,\r\n        subjectLines: [safeSubject || \"New Email Draft\"],\r\n        frameworkUsed: \"General\",\r\n        ctaType: \"Direct\",\r\n        toneApplied: safeTone,\r\n        whyThisWorks: [\"Generated a clean draft based on your input.\"]\r\n      };\r\n    }\r\n\r\n    return NextResponse.json({ result: parsedResult });\r\n\r\n  } catch (error) {\r\n    console.error(\"Email Assistant API Error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to generate email.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}