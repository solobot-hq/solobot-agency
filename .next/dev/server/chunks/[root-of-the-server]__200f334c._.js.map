{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bolad/Downloads/SoloBotAgency_SaaS_Starter/app/api/bots/ai-sales-agent/analysis/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const { text, targetAudience } = body;\r\n\r\n    if (!text) return NextResponse.json({ error: \"No text provided\" }, { status: 400 });\r\n\r\n    const systemPrompt = `\r\n      You are an elite Sales Copy Analyst & Spam Filter Simulator (Lavender/Lyne style).\r\n      Analyze the provided email text deeply.\r\n\r\n      **OUTPUT JSON STRUCTURE (Strict):**\r\n      {\r\n        \"spamScore\": number, // 0-10 (0 = Clean, 10 = Spam Trap)\r\n        \"tone\": {\r\n          \"perceived\": string, // e.g., \"Consultative\", \"Aggressive\", \"Helpful\"\r\n          \"formality\": number, // 0-10\r\n          \"aggression\": number, // 0-10\r\n          \"humanLikeness\": number // 0-10\r\n        },\r\n        \"readability\": {\r\n          \"gradeLevel\": string, // e.g., \"Grade 4\"\r\n          \"complexity\": number, // 0-10\r\n          \"sentences\": number,\r\n          \"avgWords\": number\r\n        },\r\n        \"replyProbability\": number, // 0-100 (Prediction)\r\n        \"ctaStrength\": number, // 0-10 (Urgency + Clarity - Friction)\r\n        \"suggestions\": [string, string, string] // 3 specific, actionable edits\r\n      }\r\n\r\n      **ANALYSIS RULES:**\r\n      1. **Reply Prediction:** Bonus for <100 words, clear questions, \"soft\" CTAs. Penalty for \"I hope\", \"synergy\".\r\n      2. **Spam Score:** Penalty for ALL CAPS, \"free\", \"guarantee\", \"risk-free\", multiple links.\r\n      3. **Readability:** Aim for Grade 5-7. If sentences >25 words, high complexity score.\r\n      4. **CTA Strength:** \"Worth a chat?\" (High). \"Click here to book a 30 min demo\" (Low/High Friction).\r\n    `;\r\n\r\n    const userPrompt = `\r\n      **Email Text:** \"${text}\"\r\n      **Audience Context:** \"${targetAudience}\"\r\n      \r\n      Perform the analysis.\r\n    `;\r\n\r\n    const completion = await client.chat.completions.create({\r\n      model: \"gpt-4o-mini\",\r\n      messages: [\r\n        { role: \"system\", content: systemPrompt },\r\n        { role: \"user\", content: userPrompt }\r\n      ],\r\n      response_format: { type: \"json_object\" },\r\n      temperature: 0.2, // Deterministic for analysis\r\n    });\r\n\r\n    const parsed = JSON.parse(completion.choices[0].message.content || \"{}\");\r\n\r\n    // DATA MAPPING:\r\n    // We map the new rigorous JSON structure to the exact keys your existing Frontend UI expects.\r\n    // We also include the new data fields (readability, ctaStrength) so they are available \r\n    // if you decide to display them later, without breaking current views.\r\n    \r\n    const result = {\r\n      // Legacy UI Compatibility\r\n      replyProbability: parsed.replyProbability || 50,\r\n      spamScore: parsed.spamScore || 0,\r\n      toneAnalysis: {\r\n        perceivedTone: parsed.tone?.perceived || \"Neutral\",\r\n        formality: parsed.tone?.formality || 5,\r\n        aggression: parsed.tone?.aggression || 5,\r\n        humanLikeness: parsed.tone?.humanLikeness || 5\r\n      },\r\n      suggestions: parsed.suggestions || [\"Shorten text.\", \"Check spam words.\"],\r\n      \r\n      // New Advanced Data (Available for future UI expansion)\r\n      readability: parsed.readability,\r\n      ctaStrength: parsed.ctaStrength\r\n    };\r\n\r\n    return NextResponse.json({ result });\r\n\r\n  } catch (error) {\r\n    console.error(\"Analysis API Error:\", error);\r\n    return NextResponse.json({ error: \"Analysis failed\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;;;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IAAE,QAAQ,QAAQ,GAAG,CAAC,cAAc;AAAC;AAExD,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,IAAI,EAAE,cAAc,EAAE,GAAG;QAEjC,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAmB,GAAG;YAAE,QAAQ;QAAI;QAEjF,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IA6BtB,CAAC;QAED,MAAM,aAAa,CAAC;uBACD,EAAE,KAAK;6BACD,EAAE,eAAe;;;IAG1C,CAAC;QAED,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO;YACP,UAAU;gBACR;oBAAE,MAAM;oBAAU,SAAS;gBAAa;gBACxC;oBAAE,MAAM;oBAAQ,SAAS;gBAAW;aACrC;YACD,iBAAiB;gBAAE,MAAM;YAAc;YACvC,aAAa;QACf;QAEA,MAAM,SAAS,KAAK,KAAK,CAAC,WAAW,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI;QAEnE,gBAAgB;QAChB,8FAA8F;QAC9F,wFAAwF;QACxF,uEAAuE;QAEvE,MAAM,SAAS;YACb,0BAA0B;YAC1B,kBAAkB,OAAO,gBAAgB,IAAI;YAC7C,WAAW,OAAO,SAAS,IAAI;YAC/B,cAAc;gBACZ,eAAe,OAAO,IAAI,EAAE,aAAa;gBACzC,WAAW,OAAO,IAAI,EAAE,aAAa;gBACrC,YAAY,OAAO,IAAI,EAAE,cAAc;gBACvC,eAAe,OAAO,IAAI,EAAE,iBAAiB;YAC/C;YACA,aAAa,OAAO,WAAW,IAAI;gBAAC;gBAAiB;aAAoB;YAEzE,wDAAwD;YACxD,aAAa,OAAO,WAAW;YAC/B,aAAa,OAAO,WAAW;QACjC;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAO;IAEpC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;IACvE;AACF"}}]
}